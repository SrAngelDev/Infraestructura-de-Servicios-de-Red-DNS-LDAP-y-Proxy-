server {
    listen 8080; # Bitnami corre en 8080
    server_name iesluisvives.org;

    # Ruta raíz -> Redirección simple o página home
    location / {
        return 200 "Bienvenido al Proxy del IES Luis Vives\n";
        add_header Content-Type text/plain;
    }

    # --- Servicio DAW (Nginx Backend) ---
    location /daw/ {
        proxy_pass http://backend-daw:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Servicio DAW sin barra final
    location /daw {
        proxy_pass http://backend-daw:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Protección de Calificaciones DAW en el Proxy
    # Nota: bitnami/nginx NO incluye módulo auth_ldap por defecto
    # Se debe usar auth_basic con htpasswd o construir imagen custom
    location /daw/calificaciones/ {
        auth_basic "Área Restringida DAW";
        auth_basic_user_file /opt/bitnami/nginx/conf/.htpasswd;
        
        proxy_pass http://backend-daw:80/calificaciones/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # --- Servicio DAM (Apache Backend) ---
    # Apache gestiona su propia seguridad con .htaccess
    location /dam/ {
        proxy_pass http://backend-dam:80/;
        
        # Necesario para pasar cabeceras correctamente
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Importante: pasar cabeceras de autenticación
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
    }

    # Servicio DAM sin barra final
    location /dam {
        proxy_pass http://backend-dam:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
    }
}